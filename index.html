<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Mini App tổng quan chi tiêu</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
</head>
<body>
  <style>
:root {
  --primary-color: #16A34A;
  --secondary-color: #6B7280;
  --background-color: #F7F9FC;
  --card-bg: #FFFFFF;
  --text-color: #1F2A44;
  --gradient-start: #16A34A;
  --gradient-end: #4ADE80;  
  --accent-color: #16A34A; 
}

html { 
  font-size: 16px; 
  overflow-x: hidden;
}

body {
  font-family: 'Inter', sans-serif;
  margin: 0;
  padding: 80px 20px 20px;
  background-color: var(--background-color);
  box-sizing: border-box;
  width: 100%;
  min-width: 320px;
  overflow-x: hidden;
  height: 100vh;
  font-size: 1rem;
  color: var(--text-color);
}

.content-wrapper { 
  max-width: 700px; 
  width: 100%; 
  margin: 0 auto; 
  overflow-x: hidden;
}

.tab-content { 
  display: none; 
  width: 100%; 
}

.tab-content.active { 
  display: block; 
}
</style>
<style>
.top-nav {
  position: fixed;
  top: 0; left: 0; right: 0;
  display: flex;
  justify-content: space-around;
  background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
  padding: 15px 0;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  z-index: 1000;
  height: 60px;
  width: 100%;
  max-width: 100%;
  margin: 0;
  overflow-x: hidden;
}

.nav-item {
  flex: 1;
  text-align: center;
  cursor: pointer;
  padding: 5px;
  color: #fff;
  transition: opacity 0.3s, background-color 0.3s;
  font-size: 1rem;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}

.nav-item:hover { opacity: 0.8; }
.nav-item i { font-size: 1.5rem; margin-bottom: 5px; }
.nav-item span { display: block; font-size: 0.9rem; }
.nav-item.active {
  font-weight: 600;
  color: #FFFFFF;
  position: relative;
  border-bottom: none;
}
.nav-item.active::after {
  content: '';
  position: absolute;
  bottom: -2px; left: 50%; transform: translateX(-50%);
  width: 70px; height: 2px;
  background-color: #FFFFFF;
}
</style>
<style>
h1 { 
  font-size: 2rem; 
  margin-bottom: 2rem; 
  text-align: center; 
  font-weight: 700; 
}

.input-group {
  margin-bottom: 1.5rem;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 1rem;
  width: 100%;
  padding: 0 15px;
  flex-wrap: nowrap;
}

select, input[type="date"], input[type="text"], input[type="number"] {
  padding: 0.6rem;
  font-size: 1rem;
  width: 140px;
  border-radius: 12px;
  border: 1px solid #E5E7EB;
  background-color: var(--card-bg);
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
  transition: border-color 0.3s;
}

select:focus, input[type="date"]:focus, input[type="text"]:focus, input[type="number"]:focus {
  outline: none;
  border-color: var(--primary-color);
}

button {
  padding: 0.6rem 1.5rem;
  background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
  color: white;
  border: none;
  cursor: pointer;
  font-size: 1rem;
  border-radius: 12px;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
  transition: transform 0.2s;
}

button:hover { 
  transform: translateY(-2px); 
}

.notification {
  text-align: center;
  margin-bottom: 1rem;
  font-size: 0.8rem;
  color: var(--secondary-color);
}
</style>
<style>
.stats-container {
  display: flex;
  flex-direction: row;
  justify-content: center;
  align-items: center;
  gap: 1rem;
  margin-bottom: 2rem;
  width: 100%;
}

.stat-box {
  padding: 1rem;
  width: 120px;
  border-radius: 16px;
  font-size: 0.9rem;
  flex-grow: 0;
  flex-shrink: 0;
  max-width: 140px;
  min-height: 80px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  background: linear-gradient(135deg, #F8FAFC, #E5E7EB);
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
  transition: transform 0.2s;
}

.stat-box:hover { transform: translateY(-5px); }
.stat-box .title { font-weight: 500; margin-bottom: 0.5rem; color: var(--text-color); font-size: 0.9rem; }
.stat-box .amount { font-weight: 700; font-size: 1.2rem; }
.stat-box .amount.no-data { font-size: 1rem; white-space: pre-line; text-align: center; line-height: 1.2; }
.income .amount { color: #10B981; }
.expense .amount { color: #EF4444; }
.balance .amount { color: var(--primary-color); }
</style>
<style>
.chart-container {
  margin-top: 0;
  width: 100%;
  max-width: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 2rem;
  text-align: center;
}

canvas#myChart {
  width: 100% !important;
  height: auto !important;
  max-width: 500px !important;
  aspect-ratio: 1 / 1;
  display: block;
  margin: 0 auto;
  background: var(--card-bg);
  border-radius: 16px;
  padding: 10px;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
}

.custom-legend {
  width: 100%;
  max-width: 600px;
  display: flex;
  justify-content: space-between;
  font-size: 1rem;
  padding: 0;
  margin: 2rem auto 0;
  gap: 0.3rem;
}

.custom-legend-column {
  width: 48%;
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  min-width: 280px;
}

.legend-item { display: flex; align-items: flex-start; margin-bottom: 0.8rem; }
.legend-color { width: 16px; height: 16px; margin-right: 0.75rem; border-radius: 4px; margin-top: 2px; }
.legend-text { font-size: 1rem; display: flex; flex-direction: column; }
.legend-value { font-weight: 700; margin-top: 0.2rem; }
</style>
<style>
.transactions-list {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 1rem;
  width: 100%;
  margin-bottom: 2rem;
}

.transaction-box {
  padding: 1rem;
  width: 100%;
  max-width: 600px;
  border-radius: 16px;
  font-size: 1rem;
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  background: linear-gradient(135deg, #F8FAFC, #E5E7EB);
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
  transition: transform 0.2s;
  margin-bottom: 1rem;
}

.transaction-box:hover { transform: translateY(-5px); }
.transaction-box .date { font-weight: 500; font-size: 1.1rem; color: var(--text-color); margin-bottom: 0.5rem; }
.transaction-box .amount { font-weight: 700; font-size: 1.2rem; margin-bottom: 0.5rem; }
.transaction-box .type { font-size: 1rem; margin-bottom: 0.5rem; font-weight: 700; }
.transaction-box .category { font-size: 1rem; font-style: italic; color: var(--secondary-color); }
.transaction-box .type.expense { color: #EF4444; }
.transaction-box .type.income { color: #10B981; }
.transaction-box .content { font-size: 1rem; margin-bottom: 0.5rem; white-space: normal; word-wrap: break-word; }
</style>
<style>
canvas#monthlyChart {
  width: 100% !important;
  height: auto !important;
  max-width: 500px !important;
  min-height: 350px; 
  max-height: 450px;
  display: block;
  margin: 0 auto;
  background: var(--card-bg);
  border-radius: 16px;
  padding: 10px;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
}

.monthly-legend {
  width: 100%;
  max-width: 500px;
  display: flex;
  flex-direction: column;
  font-size: 1rem;
  padding: 0 20px;
  margin: 2rem auto 0;
  gap: 1rem;
  align-items: center;
}

.monthly-column { width: 100%; max-width: 400px; display: flex; flex-direction: column; gap: 1.5rem; text-align: left; }
.month-item { text-align: left; white-space: nowrap; }
.month-item h3 { font-size: 1.2rem; margin-bottom: 0.5rem; font-weight: 500; }
.month-item p { margin: 0.5rem 0; font-size: 1rem; display: flex; align-items: center; }
.month-item .color-box { width: 16px; height: 16px; margin-right: 0.75rem; border-radius: 4px; }
.month-item .amount { font-weight: 700; margin-left: 0.5rem; }
.month-item .difference { font-weight: 700; margin-left: 0.5rem; }
.month-item .difference-icon { margin-right: 0.5rem; font-size: 0.8rem; }
.difference.positive { color: #10B981; }
.difference.negative { color: #EF4444; }
.difference-icon.positive { color: #10B981; }
.difference-icon.negative { color: #EF4444; }
</style>
<style>
.info-section {
  width: 100%;
  max-width: 500px;
  margin: 0 auto;
  padding: 0 20px;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.info-card { background: var(--card-bg); border-radius: 16px; padding: 1.5rem; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); transition: transform 0.3s ease; }
.info-card:hover { transform: translateY(-5px); }
.info-card h1 { font-size: 1.5rem; font-weight: 600; margin-bottom: 1rem; color: var(--text-color); border-left: 4px solid var(--primary-color); padding-left: 0.75rem; }
.info-card p { margin: 0.75rem 0; font-size: 1rem; line-height: 1.6; display: flex; align-items: center; gap: 10px; }
.info-card a { color: var(--primary-color); text-decoration: none; }
.info-card a:hover { text-decoration: underline; }
.custom-text { text-align: justify; font-style: italic; font-size: 1rem; color: var(--secondary-color); }
.qr-container { text-align: center; display: flex; flex-direction: column; align-items: center; gap: 0.5rem; }
.qr-frame { padding: 1rem; background: var(--card-bg); border-radius: 16px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); }
.qr-image { max-width: 100%; width: 400px; height: auto; border-radius: 12px; }
.qr-caption { margin-top: 0.5rem; font-size: 1rem; color: var(--secondary-color); font-style: italic; }
.cta-button { padding: 0.75rem 1.5rem; background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end)); color: white; border-radius: 12px; text-decoration: none; }
.cta-button:hover { transform: translateY(-3px); }
.contact-columns { display: flex; flex-direction: column; gap: 0.5rem; }
.highlight-color { color: var(--primary-color); }
</style>
<style>
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  z-index: 2000;
  justify-content: center;
  align-items: center;
}

.modal-content {
  background-color: var(--card-bg);
  padding: 1.5rem;
  border-radius: 16px;
  width: 90%;
  max-width: 400px;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

.modal-content h2 { font-size: 1.5rem; margin-bottom: 1rem; color: var(--text-color); }
.modal-content label { display: block; font-size: 1rem; margin-bottom: 0.5rem; color: var(--text-color); }
.modal-content input, .modal-content select, .modal-content textarea {
  width: 100%;
  padding: 0.6rem;
  margin-bottom: 1rem;
  border-radius: 8px;
  border: 1px solid #E5E7EB;
  font-size: 1rem;
  box-sizing: border-box;
}
.modal-content textarea { resize: vertical; min-height: 80px; }
.modal-content .btn-group { display: flex; justify-content: space-between; gap: 1rem; }
.modal-content .btn-group button { flex: 1; padding: 0.6rem; border-radius: 8px; font-size: 1rem; cursor: pointer; }
.modal-content .btn-group .save-btn { background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end)); color: white; }
.modal-content .btn-group .cancel-btn { background-color: #EF4444; color: white; }
.modal-content .error-message { color: red; font-size: 0.9rem; margin-bottom: 1rem; display: none; }
</style>
<style>
@media (max-width: 600px) {
  body { padding: 60px 5px 10px; font-size: 0.9rem; }
  h1 { font-size: 1.5rem; margin-bottom: 1rem; }
  .top-nav { height: 50px; padding: 10px 0; }
  .nav-item i { font-size: 1.2rem; }
  .nav-item span { font-size: 0.75rem; }
  .input-group { gap: 0.5rem; padding: 0 5px; }
  select, input[type="date"] { width: 110px; font-size: 0.85rem; padding: 0.6rem; }
  button { padding: 0.6rem 1rem; font-size: 0.85rem; }
  .stats-container { gap: 0.5rem; }
  .stat-box { width: 100px; max-width: 100px; padding: 0.8rem; min-height: 70px; font-size: 0.8rem; }
  canvas#myChart { max-width: 320px !important; }
  canvas#monthlyChart { max-width: 300px !important; min-height: 250px; max-height: 350px; }
  .custom-legend { flex-direction: column; max-width: 320px; font-size: 0.85rem; }
  .transaction-box { padding: 0.8rem; max-width: 320px; }
}

@media (min-width: 601px) and (max-width: 1023px) {
  body { padding: 70px 20px 20px; }
  h1 { font-size: 1.8rem; }
  .stats-container { gap: 1.5rem; }
  .stat-box { width: 130px; max-width: 130px; }
  canvas#myChart { max-width: 450px !important; }
  canvas#monthlyChart { max-width: 450px !important; min-height: 300px; max-height: 400px; }
}

@media (min-width: 1024px) {
  .content-wrapper { max-width: 800px; }
  body { padding: 80px 30px 30px; }
  h1 { font-size: 2rem; }
  .stats-container { gap: 2rem; }
  .stat-box { width: 140px; max-width: 140px; }
}
</style>
<div class="top-nav">
  <div class="nav-item active" data-tab="tab4"><i class="fas fa-list"></i><span>Giao dịch</span></div>
  <div class="nav-item" data-tab="tab1"><i class="fas fa-table"></i><span>Thống kê</span></div>
  <div class="nav-item" data-tab="tab2"><i class="fas fa-chart-bar"></i><span>Biểu đồ</span></div>
  <div class="nav-item" data-tab="tab3"><i class="fas fa-info-circle"></i><span>Giới thiệu</span></div>
</div>

<div class="content-wrapper">
 <div id="tab1" class="tab-content">
  <h1>THỐNG KẾ</h1>
  <p class="notification">Vui lòng chọn khoảng thời gian và ấn "Lọc" để xem dữ liệu.</p>
  <div id="errorMessageTab1" style="color: red; text-align: center; display: none; margin-bottom: 1rem;"></div>
  <div id="successMessageTab1" style="color: green; text-align: center; display: none; margin-bottom: 1rem;"></div>
  <div id="loadingTab1" style="display: none; text-align: center; margin: 1rem 0;">
    <i class="fas fa-spinner fa-spin" style="font-size: 1.5rem; color: var(--primary-color);"></i>
  </div>
  <div class="input-group">
    Từ: <input type="date" id="startDate"> 
    Đến: <input type="date" id="endDate"> 
    <button id="fetchDataBtn">Lọc</button>
  </div>
    <div class="stats-container" id="statsContainer">
      <div class="stat-box income"><div class="title">Tổng thu nhập</div><div class="amount">0đ</div></div>
      <div class="stat-box expense"><div class="title">Tổng chi tiêu</div><div class="amount">0đ</div></div>
      <div class="stat-box balance"><div class="title">Số dư</div><div class="amount">0đ</div></div>
    </div>
    <div class="chart-container">
      <h1>BIỂU ĐỒ CHI TIÊU</h1>
      <canvas id="myChart"></canvas>
    </div>
    <div class="custom-legend" id="customLegend"></div>
  </div>
    <div id="tab2" class="tab-content">
    <h1>BIỂU ĐỒ THU CHI THEO THÁNG</h1>
    <p class="notification">Vui lòng chọn khoảng thời gian và ấn "Lọc" để xem dữ liệu.</p>
    <div id="errorMessageTab2" style="color: red; text-align: center; display: none; margin-bottom: 1rem;"></div>
    <div id="successMessageTab2" style="color: green; text-align: center; display: none; margin-bottom: 1rem;"></div>
    <div id="loadingTab2" style="display: none; text-align: center; margin: 1rem 0;">
      <i class="fas fa-spinner fa-spin" style="font-size: 1.5rem; color: var(--primary-color);"></i>
    </div>
    <div class="input-group">
      Từ: 
      <select id="startMonth">
        <option value="1">Tháng 1</option><option value="2">Tháng 2</option><option value="3">Tháng 3</option>
        <option value="4">Tháng 4</option><option value="5">Tháng 5</option><option value="6">Tháng 6</option>
        <option value="7">Tháng 7</option><option value="8">Tháng 8</option><option value="9">Tháng 9</option>
        <option value="10">Tháng 10</option><option value="11">Tháng 11</option><option value="12">Tháng 12</option>
      </select>
      Đến: 
      <select id="endMonth">
        <option value="1">Tháng 1</option><option value="2">Tháng 2</option><option value="3">Tháng 3</option>
        <option value="4">Tháng 4</option><option value="5">Tháng 5</option><option value="6">Tháng 6</option>
        <option value="7">Tháng 7</option><option value="8">Tháng 8</option><option value="9">Tháng 9</option>
        <option value="10">Tháng 10</option><option value="11">Tháng 11</option><option value="12">Tháng 12</option>
      </select>
      <button id="fetchMonthlyDataBtn">Lọc</button>
    </div>
    <div class="chart-container">
      <canvas id="monthlyChart"></canvas>
      <div class="monthly-legend" id="monthlyLegend"></div>
    </div>
  </div>
    <div id="tab3" class="tab-content">
    <h1>GIỚI THIỆU</h1>
    <div class="info-section">
      <div class="info-card">
        <h1>Về MiniApp</h1>
        <p class="custom-text">Miniapp tài chính trên Telegram giúp bạn theo dõi thu nhập và chi tiêu dễ dàng. Dựa vào dữ liệu trong Google Sheet nó sẽ hiển thị danh sách giao dịch trong ngày, biểu đồ chi tiêu theo phân loại chi tiết và biểu đồ thu nhập – chi tiêu hàng tháng ngay trong Telegram.</p>
      </div>
      <div class="info-card">
        <h1>Ủng hộ</h1>
        <p class="custom-text">Nếu bạn thấy nó hữu ích, hãy ủng hộ mình một ly cà phê để có thêm động lực duy trì và phát triển nhé!</p>
        <p><i class="fas fa-university" style="color: var(--accent-color);"></i><strong>Ngân hàng:</strong> TMCP Sài Gòn – Hà Nội (SHB)</p>
        <p><i class="fas fa-user" style="color: var(--accent-color);"></i><strong>Chủ tài khoản:</strong> Hoang Manh Hung</p>
        <p><i class="fas fa-credit-card" style="color: var(--accent-color);"></i><strong>Số tài khoản:</strong> 6666.6789.9999</p>
      </div>
      <div class="qr-container">
        <a href="https://momo.vn/" target="_blank" class="cta-button">Ủng hộ ngay</a>
        <div class="qr-frame">
          <img id="qrImage" src="https://i.pinimg.com/736x/7c/13/53/7c135389e26cbc6460626deb9e2aa5c6.jpg" alt="QR Code" class="qr-image">
        </div>
        <p class="qr-caption">Quét mã QR để ủng hộ qua Momo</p>
      </div>
      <div class="info-card">
        <h1>Liên hệ</h1>
        <div class="contact-columns">
          <p><i class="fas fa-user" style="color: var(--primary-color);"></i><strong>Người tạo:</strong> <span class="highlight-color">Hoàng Hùng</span></p>
          <p><i class="fab fa-telegram-plane" style="color: var(--primary-color);"></i><strong>Telegram:</strong> <a href="https://t.me/masterhmh" target="_blank">@masterhmh</a></p>
          <p><i class="fab fa-facebook" style="color: var(--primary-color);"></i><strong>Facebook:</strong> <a href="https://facebook.com/masterhmh" target="_blank">facebook.com/masterhmh</a></p>
          <p><i class="fas fa-envelope" style="color: var(--primary-color);"></i><strong>Email:</strong> <a href="mailto:masterhmh@gmail.com">masterhmh@gmail.com</a></p>
        </div>
      </div>
    </div>
  </div>
    <div id="tab4" class="tab-content active">
  <h1>GIAO DỊCH TRONG NGÀY</h1>
  <p class="notification">Vui lòng chọn ngày và ấn "Lọc" để xem dữ liệu.</p>
  <div id="errorMessageTab4" style="color: red; text-align: center; display: none; margin-bottom: 1rem;"></div>
  <div id="successMessageTab4" style="color: green; text-align: center; display: none; margin-bottom: 1rem;"></div>
  <div id="loadingTab4" style="display: none; text-align: center; margin: 1rem 0;">
    <i class="fas fa-spinner fa-spin" style="font-size: 1.5rem; color: var(--primary-color);"></i>
  </div>
  <div class="input-group">
    Ngày: <input type="date" id="transactionDate">
    <button id="fetchTransactionsBtn">Lọc</button>
    <button id="addTransactionBtn">Thêm</button>
  </div>
    <div class="stats-container" id="dailySummary">
      <div class="stat-box income"><div class="title">Tổng thu nhập</div><div class="amount">0đ</div></div>
      <div class="stat-box expense"><div class="title">Tổng chi tiêu</div><div class="amount">0đ</div></div>
      <div class="stat-box balance"><div class="title">Số dư</div><div class="amount">0đ</div></div>
    </div>
    <div class="transactions-list" id="transactionsContainer"></div>
    <div id="pagination" style="text-align: center; margin-top: 1rem;">
      <button id="prevPage" disabled>Trang trước</button>
      <span id="pageInfo"></span>
      <button id="nextPage">Trang sau</button>
    </div>
  </div>
</div>

<div id="editModal" class="modal">
  <div class="modal-content">
    <h2>Chỉnh sửa giao dịch</h2>
    <div id="editError" class="error-message"></div>
    <form id="editForm">
      <input type="hidden" id="editTransactionId">
      <label for="editDate">Ngày (dd/MM):</label>
      <input type="text" id="editDate" required pattern="\d{1,2}/\d{1,2}" placeholder="dd/MM">
      <label for="editContent">Nội dung:</label>
      <input type="text" id="editContent" required>
      <label for="editAmount">Số tiền:</label>
      <input type="number" id="editAmount" min="0" required>
      <label for="editType">Phân loại:</label>
      <select id="editType" required>
        <option value="Thu nhập">Thu nhập</option>
        <option value="Chi tiêu">Chi tiêu</option>
      </select>
      <label for="editCategory">Phân loại chi tiết:</label>
      <select id="editCategory" required></select>
      <label for="editNote">Ghi chú (nếu có):</label>
      <textarea id="editNote"></textarea>
      <div class="btn-group">
        <button type="button" class="cancel-btn" onclick="closeEditForm()">Hủy</button>
        <button type="submit" class="save-btn">Lưu</button>
      </div>
    </form>
  </div>
</div>

<div id="addModal" class="modal">
  <div class="modal-content">
    <h2>Thêm giao dịch mới</h2>
    <div id="addError" class="error-message"></div>
    <form id="addForm">
      <label for="addDate">Ngày (dd/MM):</label>
      <input type="text" id="addDate" required pattern="\d{1,2}/\d{1,2}" placeholder="dd/MM">
      <label for="addContent">Nội dung:</label>
      <input type="text" id="addContent" required>
      <label for="addAmount">Số tiền:</label>
      <input type="number" id="addAmount" min="0" required>
      <label for="addType">Phân loại:</label>
      <select id="addType" required>
        <option value="Thu nhập">Thu nhập</option>
        <option value="Chi tiêu">Chi tiêu</option>
      </select>
      <label for="addCategory">Phân loại chi tiết:</label>
      <select id="addCategory" required></select>
      <label for="addNote">Ghi chú (nếu có):</label>
      <textarea id="addNote"></textarea>
      <div class="btn-group">
        <button type="button" class="cancel-btn" onclick="closeAddForm()">Hủy</button>
        <button type="submit" class="save-btn">Lưu</button>
      </div>
    </form>
  </div>
</div>
<script>
// Lấy thông số API và Sheet ID từ URL
const urlParams = new URLSearchParams(window.location.search);
const apiUrl = 'https://proxy-server.masterhmh.workers.dev/';
const sheetId = urlParams.get('sheetId');

if (!apiUrl || !sheetId) {
  alert("Thiếu thông tin API hoặc Sheet ID. Vui lòng kiểm tra lại URL!");
}

// Hàm hiển thị thông báo lỗi và thành công
function showError(message, tabId) {
  const errorDiv = document.getElementById(`errorMessage${tabId.charAt(0).toUpperCase() + tabId.slice(1)}`);
  if (errorDiv) {
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
    setTimeout(() => errorDiv.style.display = 'none', 5000);
  }
}

function showSuccess(message, tabId) {
  const successDiv = document.getElementById(`successMessage${tabId.charAt(0).toUpperCase() + tabId.slice(1)}`);
  if (successDiv) {
    successDiv.textContent = message;
    successDiv.style.display = 'block';
    setTimeout(() => successDiv.style.display = 'none', 5000);
  }
}

function showModalError(modalId, message) {
  const errorDiv = document.getElementById(`${modalId}Error`);
  if (errorDiv) {
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
    setTimeout(() => errorDiv.style.display = 'none', 5000);
  }
}

function showLoading(show, tabId) {
  let loadingElement;
  if (tabId === 'tab1') loadingElement = document.getElementById('loadingTab1');
  else if (tabId === 'tab2') loadingElement = document.getElementById('loadingTab2');
  else if (tabId === 'tab4') loadingElement = document.getElementById('loadingTab4');
  if (loadingElement) loadingElement.style.display = show ? 'block' : 'none';
}

// Mở tab
window.openTab = function(tabId) {
  const tabs = document.querySelectorAll('.nav-item');
  const contents = document.querySelectorAll('.tab-content');
  tabs.forEach(tab => tab.classList.remove('active'));
  contents.forEach(content => content.classList.remove('active'));
  document.getElementById(tabId).classList.add('active');
  document.querySelector(`.nav-item[data-tab="${tabId}"]`).classList.add('active');
};
</script>
<script>
// Lấy dữ liệu thống kê (Tab 1)
let cachedFinancialData = null;
let cachedChartData = null;

window.fetchData = async function() {
  const startDateInput = document.getElementById('startDate').value;
  const endDateInput = document.getElementById('endDate').value;
  if (!startDateInput || !endDateInput) {
    showError("Vui lòng chọn khoảng thời gian!", 'tab1');
    return;
  }
  const startDate = new Date(startDateInput);
  const endDate = new Date(endDateInput);
  if (startDate > endDate) {
    showError("Ngày bắt đầu không thể lớn hơn ngày kết thúc!", 'tab1');
    return;
  }

  const cacheKey = `${startDateInput}-${endDateInput}`;
  if (cachedFinancialData && cachedChartData && cachedFinancialData.cacheKey === cacheKey) {
    updateFinancialData(cachedFinancialData.data);
    updateChartData(cachedChartData.data);
    return;
  }

  showLoading(true, 'tab1'); // Hiển thị loading
  try {
    const financialResponse = await fetch(`${apiUrl}?action=getFinancialSummary&startDate=${startDateInput}&endDate=${endDateInput}&sheetId=${sheetId}`);
    const financialData = await financialResponse.json();
    if (financialData.error) throw new Error(financialData.error);
    cachedFinancialData = { cacheKey, data: financialData };
    updateFinancialData(financialData);

    const chartResponse = await fetch(`${apiUrl}?action=getChartData&startDate=${startDateInput}&endDate=${endDateInput}&sheetId=${sheetId}`);
    const chartData = await chartResponse.json();
    if (chartData.error) throw new Error(chartData.error);
    cachedChartData = { cacheKey, data: chartData };
    updateChartData(chartData);
  } catch (error) {
    showError("Lỗi khi lấy dữ liệu: " + error.message, 'tab1');
    updateFinancialData({ error: true });
  } finally {
    showLoading(false, 'tab1'); // Ẩn loading
  }
};

// Cập nhật dữ liệu thống kê
function updateFinancialData(data) {
  const container = document.getElementById('statsContainer');
  if (!data || data.error || (data.income === 0 && data.expense === 0)) {
    container.innerHTML = `
      <div class="stat-box income"><div class="title">Tổng thu nhập</div><div class="amount no-data">Không có<br>dữ liệu</div></div>
      <div class="stat-box expense"><div class="title">Tổng chi tiêu</div><div class="amount no-data">Không có<br>dữ liệu</div></div>
      <div class="stat-box balance"><div class="title">Số dư</div><div class="amount no-data">Không có<br>dữ liệu</div></div>
    `;
    return;
  }
  const totalIncome = Number(data.income) || 0;
  const totalExpense = Number(data.expense) || 0;
  const balance = totalIncome - totalExpense;
  container.innerHTML = `
    <div class="stat-box income"><div class="title">Tổng thu nhập</div><div class="amount">${totalIncome.toLocaleString('vi-VN')}đ</div></div>
    <div class="stat-box expense"><div class="title">Tổng chi tiêu</div><div class="amount">${totalExpense.toLocaleString('vi-VN')}đ</div></div>
    <div class="stat-box balance"><div class="title">Số dư</div><div class="amount">${balance.toLocaleString('vi-VN')}đ</div></div>
  `;
}

// Cập nhật biểu đồ chi tiêu (Tab 1)
function updateChartData(response) {
  if (response.error) {
    showError(response.error, 'tab1');
    if (window.myChart && typeof window.myChart.destroy === 'function') {
      window.myChart.destroy();
    }
    return;
  }
  const chartData = response.chartData;
  const categories = response.categories;
  const ctx = document.getElementById('myChart').getContext('2d');
  if (window.myChart && typeof window.myChart.destroy === 'function') {
    window.myChart.destroy();
  }
  const totalAmount = chartData.reduce((sum, item) => sum + item.amount, 0);
  const backgroundColors = [
    '#FF6B6B', '#FF9F45', '#FFE156', '#7DC95E', '#40C4FF',
    '#5A92FF', '#9B5DE5', '#FF66C4', '#FF7D7D', '#F88F70',
    '#54A0FF', '#C084FC', '#FF82A9', '#6DCFF6', '#FFACC5',
    '#E4C1F9', '#FF928B', '#FDCB98', '#B5E2FA', '#91E8BC',
    '#FFD166', '#FF8E72', '#E57373', '#74D3AE', '#43BCCD',
    '#D1B3E0', '#F78F8F', '#F6B17A', '#F4A261', '#FF6392',
    '#66D9E8', '#FF85A1', '#6A0572', '#FC7A57', '#A29BFE'
  ];
  const customLegend = document.getElementById('customLegend');
  customLegend.innerHTML = '';
  const leftColumn = document.createElement('div');
  leftColumn.className = 'custom-legend-column';
  const rightColumn = document.createElement('div');
  rightColumn.className = 'custom-legend-column';
  chartData.forEach((item, i) => {
    const index = categories.indexOf(item.category);
    const color = backgroundColors[index % backgroundColors.length];
    const percentage = ((item.amount / totalAmount) * 100).toFixed(1);
    const legendItem = document.createElement('div');
    legendItem.className = 'legend-item';
    legendItem.innerHTML = `
      <span class="legend-color" style="background-color: ${color};"></span>
      <span class="legend-text">
        ${item.category}:
        <span class="legend-value">${item.amount.toLocaleString('vi-VN')}đ (${percentage}%)</span>
      </span>
    `;
    if (i % 2 === 0) {
      leftColumn.appendChild(legendItem);
    } else {
      rightColumn.appendChild(legendItem);
    }
  });
  customLegend.appendChild(leftColumn);
  customLegend.appendChild(rightColumn);
  window.myChart = new Chart(ctx, {
    type: 'pie',
    data: {
      labels: chartData.map(item => item.category),
      datasets: [{
        data: chartData.map(item => item.amount),
        backgroundColor: chartData.map(item => {
          const index = categories.indexOf(item.category);
          return backgroundColors[index % backgroundColors.length];
        })
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      aspectRatio: 1,
      plugins: {
        legend: { display: false },
        tooltip: {
          mode: 'index',
          intersect: false,
          callbacks: {
            label: function(tooltipItem) {
              const category = tooltipItem.label;
              const amount = tooltipItem.raw;
              const percentage = ((amount / totalAmount) * 100).toFixed(1);
              return `${category}: ${amount.toLocaleString('vi-VN')}đ (${percentage}%)`;
            }
          },
          backgroundColor: 'rgba(0, 0, 0, 0.8)',
          titleFont: { size: 12 },
          bodyFont: { size: 10 },
          titleColor: '#fff',
          bodyColor: '#fff',
          padding: 8,
          displayColors: true,
        },
        datalabels: {
          formatter: (value, context) => {
            const percentage = ((value / totalAmount) * 100).toFixed(1);
            return percentage >= 1 ? `${value.toLocaleString('vi-VN')}đ (${percentage}%)` : '';
          },
          color: '#fff',
          font: { weight: 'bold', size: 12 },
          anchor: 'end',
          align: 'end',
          clamp: true
        }
      }
    }
  });
}
</script>
<script>
// Lấy dữ liệu biểu đồ tháng (Tab 2)
window.fetchMonthlyData = async function() {
  const startMonth = parseInt(document.getElementById('startMonth').value);
  const endMonth = parseInt(document.getElementById('endMonth').value);
  const year = new Date().getFullYear();
  console.log("Fetching monthly data from month: " + startMonth + " to: " + endMonth);
  if (startMonth > endMonth) {
    alert("Tháng bắt đầu không thể lớn hơn tháng kết thúc!");
    return;
  }

  showLoading(true, 'tab2'); // Hiển thị icon loading trước khi fetch dữ liệu
  try {
    const response = await fetch(`${apiUrl}?action=getMonthlyData&year=${year}&sheetId=${sheetId}`);
    const monthlyData = await response.json();
    console.log("Monthly data received: ", monthlyData);
    if (monthlyData.error) {
      throw new Error(monthlyData.error);
    }

    const fullYearData = Array.from({ length: 12 }, (_, i) => {
      const month = i + 1;
      const existingData = monthlyData.find(item => item.month === month);
      return existingData || { month, income: 0, expense: 0 };
    });

    const filteredData = Array.from({ length: endMonth - startMonth + 1 }, (_, i) => {
      const month = startMonth + i;
      const existingData = fullYearData.find(item => item.month === month);
      return existingData || { month, income: 0, expense: 0 };
    });

    updateMonthlyChart(filteredData);
  } catch (error) {
    console.error("Error fetching monthly data: ", error);
    alert("Lỗi khi lấy dữ liệu biểu đồ tháng: " + error.message);
    const filteredData = Array.from({ length: endMonth - startMonth + 1 }, (_, i) => ({
      month: startMonth + i,
      income: 0,
      expense: 0
    }));
    updateMonthlyChart(filteredData);
  } finally {
    showLoading(false, 'tab2'); // Ẩn icon loading sau khi hoàn tất (dù thành công hay thất bại)
  }
};

// Cập nhật biểu đồ tháng (Tab 2)
function updateMonthlyChart(filteredData) {
  const ctx = document.getElementById('monthlyChart').getContext('2d');

  // Kiểm tra và hủy biểu đồ cũ nếu tồn tại và có phương thức destroy
  if (window.monthlyChart && typeof window.monthlyChart.destroy === 'function') {
    try {
      window.monthlyChart.destroy();
    } catch (error) {
      console.error("Lỗi khi hủy biểu đồ cũ: ", error);
    }
  }

  if (!filteredData || filteredData.length === 0) {
    window.monthlyChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['Không có dữ liệu'],
        datasets: [
          { label: 'Thu nhập', data: [0], backgroundColor: '#10B981' },
          { label: 'Chi tiêu', data: [0], backgroundColor: '#EF4444' }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        aspectRatio: 1,
        scales: {
          y: { 
            beginAtZero: true, 
            title: { display: true, text: 'Số tiền (đ)', font: { size: 14 } }, 
            ticks: { font: { size: 12 } } 
          },
          x: { 
            title: { display: true, text: 'Tháng', font: { size: 14 } }, 
            ticks: { font: { size: 12 } } 
          }
        },
        plugins: {
          legend: { display: true, labels: { font: { size: 12 } } },
          tooltip: {
            titleFont: { size: 12 },
            bodyFont: { size: 12 },
            callbacks: {
              label: function(tooltipItem) {
                return `${tooltipItem.dataset.label}: ${tooltipItem.raw.toLocaleString('vi-VN')}đ`;
              }
            }
          },
          datalabels: { display: false }
        }
      }
    });
    document.getElementById('monthlyLegend').innerHTML = '<div>Không có dữ liệu</div>';
    return;
  }

  const labels = filteredData.map(item => `Tháng ${item.month}`);
  const incomes = filteredData.map(item => item.income || 0);
  const expenses = filteredData.map(item => item.expense || 0);

  window.monthlyChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [
        { label: 'Thu nhập', data: incomes, backgroundColor: '#10B981', borderColor: '#10B981', borderWidth: 1 },
        { label: 'Chi tiêu', data: expenses, backgroundColor: '#EF4444', borderColor: '#EF4444', borderWidth: 1 }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      aspectRatio: 1,
      scales: {
        y: {
          beginAtZero: true,
          title: { display: true, text: 'Số tiền (đ)', font: { size: 14 } },
          ticks: {
            callback: function(value) { return value.toLocaleString('vi-VN') + 'đ'; },
            font: { size: 12 }
          }
        },
        x: {
          title: { display: true, text: 'Tháng', font: { size: 14 } },
          ticks: {
            font: { size: 10 },
            maxRotation: 45,
            minRotation: 45,
            autoSkip: false
          }
        }
      },
      plugins: {
        legend: { display: true, labels: { font: { size: 12 } } },
        tooltip: {
          titleFont: { size: 12 },
          bodyFont: { size: 12 },
          callbacks: {
            label: function(tooltipItem) {
              return `${tooltipItem.dataset.label}: ${tooltipItem.raw.toLocaleString('vi-VN')}đ`;
            }
          }
        },
        datalabels: {
          display: true,
          align: 'end',
          anchor: 'end',
          formatter: (value) => value.toLocaleString('vi-VN') + 'đ',
          color: '#1F2A44',
          font: { weight: 'bold', size: 12 }
        }
      }
    }
  });

  const monthlyLegend = document.getElementById('monthlyLegend');
  monthlyLegend.innerHTML = '';
  const column = document.createElement('div');
  column.className = 'monthly-column';

  filteredData.forEach(item => {
    const difference = (item.income || 0) - (item.expense || 0);
    const diffClass = difference >= 0 ? 'positive' : 'negative';
    const diffIcon = difference >= 0 ? 'fa-arrow-up' : 'fa-arrow-down'; // Sửa lỗi 'fa-amazon-up' thành 'fa-arrow-up'
    const monthItem = document.createElement('div');
    monthItem.className = 'month-item';
    monthItem.innerHTML = `
      <h3>Tháng ${item.month}:</h3>
      <p><span class="color-box" style="background-color: #10B981;"></span>Tổng thu nhập: <strong>${(item.income || 0).toLocaleString('vi-VN')}đ</strong></p>
      <p><span class="color-box" style="background-color: #EF4444;"></span>Tổng chi tiêu: <strong>${(item.expense || 0).toLocaleString('vi-VN')}đ</strong></p>
      <p><i class="fas ${diffIcon} difference-icon ${diffClass}"></i>Chênh lệch: <span class="difference ${diffClass}"><strong>${difference.toLocaleString('vi-VN')}đ</strong></span></p>
    `;
    column.appendChild(monthItem);
  });

  monthlyLegend.appendChild(column);
}
</script>
<script>
// Lấy giao dịch trong ngày (Tab 4)
let cachedTransactions = null;
let currentPage = 1;
const transactionsPerPage = 10;

window.fetchTransactions = async function() {
  const transactionDate = document.getElementById('transactionDate').value;
  if (!transactionDate) {
    showError("Vui lòng chọn ngày để xem giao dịch!", 'tab4');
    return;
  }
  const dateForApi = transactionDate;
  const [year, month, day] = transactionDate.split('-');
  const formattedDateForDisplay = `${day.padStart(2, '0')}/${month.padStart(2, '0')}/${year}`;
  const cacheKey = `${formattedDateForDisplay}`; // Xóa searchQuery khỏi cacheKey

  if (cachedTransactions && cachedTransactions.cacheKey === cacheKey) {
    displayTransactions(cachedTransactions.data);
    return;
  }

  showLoading(true, 'tab4');
  try {
    const response = await fetch(`${apiUrl}?action=getTransactionsByDate&date=${encodeURIComponent(dateForApi)}&sheetId=${sheetId}`);
    const transactionData = await response.json();
    if (transactionData.error) throw new Error(transactionData.error);
    cachedTransactions = { cacheKey, data: transactionData }; // Không lọc searchQuery nữa
    displayTransactions(transactionData);
  } catch (error) {
    showError("Lỗi khi lấy dữ liệu giao dịch: " + error.message, 'tab4');
    displayTransactions({ error: true });
  } finally {
    showLoading(false, 'tab4');
  }
};

// Trong phần khởi tạo, xóa sự kiện input của searchQuery
document.addEventListener('DOMContentLoaded', function() {
  const navItems = document.querySelectorAll('.nav-item');
  navItems.forEach(item => {
    item.addEventListener('click', function() {
      window.openTab(this.getAttribute('data-tab'));
    });
  });

  document.getElementById('fetchDataBtn').addEventListener('click', window.fetchData);
  document.getElementById('fetchMonthlyDataBtn').addEventListener('click', window.fetchMonthlyData);
  document.getElementById('fetchTransactionsBtn').addEventListener('click', window.fetchTransactions);
  document.getElementById('addTransactionBtn').addEventListener('click', openAddForm);

  document.getElementById('prevPage').addEventListener('click', () => {
    if (currentPage > 1) {
      currentPage--;
      window.fetchTransactions();
    }
  });
  document.getElementById('nextPage').addEventListener('click', () => {
    const totalPages = Math.ceil((cachedTransactions?.data.length || 0) / transactionsPerPage);
    if (currentPage < totalPages) {
      currentPage++;
      window.fetchTransactions();
    }
  });

  const today = new Date();
  const startDate = new Date(today.getFullYear(), today.getMonth(), 1);
  const endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
  document.getElementById('startDate').value = formatDateToYYYYMMDD(startDate);
  document.getElementById('endDate').value = formatDateToYYYYMMDD(today);
  document.getElementById('startMonth').value = 1;
  document.getElementById('endMonth').value = 12;
  document.getElementById('transactionDate').value = formatDateToYYYYMMDD(today);

  window.openTab('tab4');
});

// Hiển thị giao dịch với phân trang
function displayTransactions(data) {
  const container = document.getElementById('transactionsContainer');
  const summaryContainer = document.getElementById('dailySummary');
  const pageInfo = document.getElementById('pageInfo');
  const prevPageBtn = document.getElementById('prevPage');
  const nextPageBtn = document.getElementById('nextPage');
  container.innerHTML = '';

  if (data.error || !data || data.length === 0) {
    container.innerHTML = '<div>Không có giao dịch trong ngày này</div>';
    summaryContainer.innerHTML = `
      <div class="stat-box income"><div class="title">Tổng thu nhập</div><div class="amount no-data">Không có<br>dữ liệu</div></div>
      <div class="stat-box expense"><div class="title">Tổng chi tiêu</div><div class="amount no-data">Không có<br>dữ liệu</div></div>
      <div class="stat-box balance"><div class="title">Số dư</div><div class="amount no-data">Không có<br>dữ liệu</div></div>
    `;
    pageInfo.textContent = '';
    prevPageBtn.disabled = true;
    nextPageBtn.disabled = true;
    return;
  }

  let totalIncome = 0, totalExpense = 0;
  data.forEach(item => {
    if (item.type === 'Thu nhập') totalIncome += item.amount;
    else if (item.type === 'Chi tiêu') totalExpense += item.amount;
  });
  const balance = totalIncome - totalExpense;
  summaryContainer.innerHTML = `
    <div class="stat-box income"><div class="title">Tổng thu nhập</div><div class="amount">${totalIncome.toLocaleString('vi-VN')}đ</div></div>
    <div class="stat-box expense"><div class="title">Tổng chi tiêu</div><div class="amount">${totalExpense.toLocaleString('vi-VN')}đ</div></div>
    <div class="stat-box balance"><div class="title">Số dư</div><div class="amount">${balance.toLocaleString('vi-VN')}đ</div></div>
  `;

  const totalPages = Math.ceil(data.length / transactionsPerPage);
  const startIndex = (currentPage - 1) * transactionsPerPage;
  const endIndex = startIndex + transactionsPerPage;
  const paginatedData = data.slice(startIndex, endIndex);

  paginatedData.forEach(item => {
    const transactionBox = document.createElement('div');
    transactionBox.className = 'transaction-box';
    const amountColor = item.type === 'Thu nhập' ? '#10B981' : '#EF4444';
    const typeClass = item.type === 'Thu nhập' ? 'income' : 'expense';
    transactionBox.innerHTML = `
      <div style="display: flex; justify-content: space-between; width: 100%;">
        <div style="flex: 1;">
          <div class="date">${formatDate(item.date)}</div>
          <div class="amount" style="color: ${amountColor}">${item.amount.toLocaleString('vi-VN')}đ</div>
          <div class="content">Nội dung: ${item.content}${item.note ? ` (${item.note})` : ''}</div>
        </div>
        <div style="flex: 1; text-align: right;">
          <div class="type ${typeClass}">Phân loại: ${item.type}</div>
          <div class="category">Phân loại chi tiết: ${item.category}</div>
        </div>
      </div>
      <div style="margin-top: 0.5rem;">
        <button class="edit-btn" data-id="${item.id}" style="background: #FFA500; color: white; padding: 0.3rem 0.8rem; border-radius: 8px;">Sửa</button>
        <button class="delete-btn" data-id="${item.id}" style="background: #EF4444; color: white; padding: 0.3rem 0.8rem; border-radius: 8px; margin-left: 0.5rem;">Xóa</button>
      </div>
    `;
    container.appendChild(transactionBox);
  });

  pageInfo.textContent = `Trang ${currentPage} / ${totalPages}`;
  prevPageBtn.disabled = currentPage === 1;
  nextPageBtn.disabled = currentPage === totalPages;

  document.querySelectorAll('.edit-btn').forEach(button => {
    const transactionId = button.getAttribute('data-id');
    const transaction = data.find(item => String(item.id) === String(transactionId)); // Đảm bảo so sánh kiểu string
    if (!transaction) {
      console.error(`Không tìm thấy giao dịch với ID: ${transactionId}`);
      return;
    }
    button.addEventListener('click', () => openEditForm(transaction));
  });

  document.querySelectorAll('.delete-btn').forEach(button => {
    button.addEventListener('click', () => deleteTransaction(button.getAttribute('data-id')));
  });
}
// Định dạng ngày
function formatDate(dateStr) {
  const parts = dateStr.split('/');
  if (parts.length !== 3) return dateStr;
  const [day, month, year] = parts;
  return `${day.padStart(2, '0')}/${month.padStart(2, '0')}/${year}`;
}
</script>
<script>
// Lấy danh sách phân loại chi tiết
async function fetchCategories() {
  try {
    const response = await fetch(`${apiUrl}?action=getCategories&sheetId=${sheetId}`);
    const categoriesData = await response.json();
    if (categoriesData.error) throw new Error(categoriesData.error);
    return categoriesData;
  } catch (error) {
    showError("Lỗi khi lấy danh sách phân loại: " + error.message, 'tab4');
    return [];
  }
}

// Mở form chỉnh sửa giao dịch
async function openEditForm(transaction) {
  if (!transaction) {
    showError('Dữ liệu giao dịch không hợp lệ!', 'tab4');
    return;
  }
  const modal = document.getElementById('editModal');
  const form = document.getElementById('editForm');
  const categorySelect = document.getElementById('editCategory');
  const currentYear = new Date().getFullYear();

  document.getElementById('editTransactionId').value = transaction.id || '';
  document.getElementById('editContent').value = transaction.content || '';
  document.getElementById('editAmount').value = transaction.amount || 0;
  document.getElementById('editType').value = transaction.type || 'Thu nhập';
  document.getElementById('editDate').value = transaction.date ? transaction.date.split('/').slice(0, 2).join('/') : '';
  document.getElementById('editNote').value = transaction.note || '';

  const categories = await fetchCategories();
  categorySelect.innerHTML = '';
  categories.forEach(category => {
    const option = document.createElement('option');
    option.value = category;
    option.textContent = category;
    if (category === transaction.category) option.selected = true;
    categorySelect.appendChild(option);
  });

  modal.style.display = 'flex';
  form.onsubmit = async function(e) {
    e.preventDefault();
    const dateInput = document.getElementById('editDate').value;
    if (!/^\d{1,2}\/\d{1,2}$/.test(dateInput)) {
      showModalError('edit', 'Ngày phải có định dạng dd/MM!');
      return;
    }
    const [day, month] = dateInput.split('/').map(Number);
    const today = new Date();
    const inputDate = new Date(currentYear, month - 1, day);
    if (inputDate > today) {
      showModalError('edit', 'Không thể chọn ngày trong tương lai!');
      return;
    }
    if (day < 1 || day > 31 || month < 1 || month > 12) {
      showModalError('edit', 'Ngày hoặc tháng không hợp lệ!');
      return;
    }
    const amount = parseFloat(document.getElementById('editAmount').value);
    if (amount <= 0) {
      showModalError('edit', 'Số tiền phải lớn hơn 0!');
      return;
    }
    const updatedTransaction = {
      id: document.getElementById('editTransactionId').value,
      content: document.getElementById('editContent').value,
      amount: amount,
      type: document.getElementById('editType').value,
      category: document.getElementById('editCategory').value,
      note: document.getElementById('editNote').value || '',
      date: `${dateInput}/${currentYear}`,
      action: 'updateTransaction'
    };
    await saveTransaction(updatedTransaction);
  };
}

// Mở form thêm giao dịch
async function openAddForm() {
  const modal = document.getElementById('addModal');
  const form = document.getElementById('addForm');
  const categorySelect = document.getElementById('addCategory');
  const currentYear = new Date().getFullYear();

  document.getElementById('addDate').value = formatDateToDDMM(new Date());
  document.getElementById('addContent').value = '';
  document.getElementById('addAmount').value = '';
  document.getElementById('addType').value = 'Thu nhập';
  document.getElementById('addNote').value = '';

  const categories = await fetchCategories();
  categorySelect.innerHTML = '';
  categories.forEach(category => {
    const option = document.createElement('option');
    option.value = category;
    option.textContent = category;
    categorySelect.appendChild(option);
  });

  modal.style.display = 'flex';
  form.onsubmit = async function(e) {
    e.preventDefault();
    const dateInput = document.getElementById('addDate').value;
    if (!/^\d{1,2}\/\d{1,2}$/.test(dateInput)) {
      showModalError('add', 'Ngày phải có định dạng dd/MM!');
      return;
    }
    const [day, month] = dateInput.split('/').map(Number);
    const today = new Date();
    const inputDate = new Date(currentYear, month - 1, day);
    if (inputDate > today) {
      showModalError('add', 'Không thể chọn ngày trong tương lai!');
      return;
    }
    if (day < 1 || day > 31 || month < 1 || month > 12) {
      showModalError('add', 'Ngày hoặc tháng không hợp lệ!');
      return;
    }
    const amount = parseFloat(document.getElementById('addAmount').value);
    if (amount <= 0) {
      showModalError('add', 'Số tiền phải lớn hơn 0!');
      return;
    }
    const newTransaction = {
      content: document.getElementById('addContent').value,
      amount: amount,
      type: document.getElementById('addType').value,
      category: document.getElementById('addCategory').value,
      note: document.getElementById('addNote').value || '',
      date: `${dateInput}/${currentYear}`,
      action: 'addTransaction'
    };
    await addTransaction(newTransaction);
  };
}

// Đóng form
function closeEditForm() { document.getElementById('editModal').style.display = 'none'; }
function closeAddForm() { document.getElementById('addModal').style.display = 'none'; }

// Lưu giao dịch đã chỉnh sửa
async function saveTransaction(updatedTransaction) {
  showLoading(true, 'tab4');
  try {
    const response = await fetch(apiUrl, {  // Chỉ dùng apiUrl, không thêm query string
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(updatedTransaction)
    });
    const result = await response.json();
    if (result.error) throw new Error(result.error);
    showSuccess("Cập nhật giao dịch thành công!", 'tab4');
    closeEditForm();
    window.fetchTransactions();
  } catch (error) {
    showError("Lỗi khi cập nhật giao dịch: " + error.message, 'tab4');
  } finally {
    showLoading(false, 'tab4');
  }
}

// Thêm giao dịch mới
async function addTransaction(newTransaction) {
  showLoading(true, 'tab4');
  try {
    const response = await fetch(apiUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(newTransaction)
    });
    const result = await response.json();
    if (result.error) throw new Error(result.error);
    showSuccess("Thêm giao dịch thành công!", 'tab4');
    closeAddForm();
    window.fetchTransactions();
  } catch (error) {
    showError("Lỗi khi thêm giao dịch: " + error.message, 'tab4');
  } finally {
    showLoading(false, 'tab4');
  }
}

// Xóa giao dịch
async function deleteTransaction(transactionId) {
  if (!confirm("Bạn có chắc chắn muốn xóa giao dịch này?")) return;
  showLoading(true, 'tab4');
  try {
    const transaction = cachedTransactions.data.find(item => String(item.id) === String(transactionId));
    if (!transaction) throw new Error("Không tìm thấy giao dịch để xóa!");
    const response = await fetch(apiUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        action: 'deleteTransaction', 
        id: transactionId, 
        sheetId: sheetId, 
        date: transaction.date // Gửi thêm ngày giao dịch
      })
    });
    const result = await response.json();
    if (result.error) throw new Error(result.error);
    showSuccess("Xóa giao dịch thành công!", 'tab4');
    window.fetchTransactions();
  } catch (error) {
    showError("Lỗi khi xóa giao dịch: " + error.message, 'tab4');
  } finally {
    showLoading(false, 'tab4');
  }
}

// Định dạng ngày thành DD/MM
function formatDateToDDMM(date) {
  const day = String(date.getDate()).padStart(2, '0');
  const month = String(date.getMonth() + 1).padStart(2, '0');
  return `${day}/${month}`;
}
</script>
<script>
// Khởi tạo khi tải trang
document.addEventListener('DOMContentLoaded', function() {
  const navItems = document.querySelectorAll('.nav-item');
  navItems.forEach(item => {
    item.addEventListener('click', function() {
      window.openTab(this.getAttribute('data-tab'));
    });
  });

  document.getElementById('fetchDataBtn').addEventListener('click', window.fetchData);
  document.getElementById('fetchMonthlyDataBtn').addEventListener('click', window.fetchMonthlyData);
  document.getElementById('fetchTransactionsBtn').addEventListener('click', window.fetchTransactions);
  document.getElementById('addTransactionBtn').addEventListener('click', openAddForm);
  document.getElementById('searchQuery').addEventListener('input', window.fetchTransactions);

  document.getElementById('prevPage').addEventListener('click', () => {
    if (currentPage > 1) {
      currentPage--;
      window.fetchTransactions();
    }
  });
  document.getElementById('nextPage').addEventListener('click', () => {
    const totalPages = Math.ceil((cachedTransactions?.data.length || 0) / transactionsPerPage);
    if (currentPage < totalPages) {
      currentPage++;
      window.fetchTransactions();
    }
  });

  const today = new Date();
  const startDate = new Date(today.getFullYear(), today.getMonth(), 1);
  const endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
  document.getElementById('startDate').value = formatDateToYYYYMMDD(startDate);
  document.getElementById('endDate').value = formatDateToYYYYMMDD(today);
  document.getElementById('startMonth').value = 1;
  document.getElementById('endMonth').value = 12;
  document.getElementById('transactionDate').value = formatDateToYYYYMMDD(today);

  window.openTab('tab4');
});

// Định dạng ngày thành YYYY-MM-DD
function formatDateToYYYYMMDD(date) {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}
</script>
</body>
</html>
